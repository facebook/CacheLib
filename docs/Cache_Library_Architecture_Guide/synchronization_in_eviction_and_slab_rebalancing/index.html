<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Cache_Library_Architecture_Guide/synchronization_in_eviction_and_slab_rebalancing">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Synchronization between Eviction &amp; Slab-movement | CacheLib</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-rh="true" name="twitter:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-rh="true" property="og:url" content="https://cachelib.org/docs/Cache_Library_Architecture_Guide/synchronization_in_eviction_and_slab_rebalancing"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Synchronization between Eviction &amp; Slab-movement | CacheLib"><meta data-rh="true" name="description" content="Overview"><meta data-rh="true" property="og:description" content="Overview"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/synchronization_in_eviction_and_slab_rebalancing"><link data-rh="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/synchronization_in_eviction_and_slab_rebalancing" hreflang="en"><link data-rh="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/synchronization_in_eviction_and_slab_rebalancing" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CacheLib RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CacheLib Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="CacheLib" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.9576b86a.css">
<link rel="preload" href="/assets/js/runtime~main.c10705de.js" as="script">
<link rel="preload" href="/assets/js/main.a9e49b72.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script>

<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#20232a;color:#fff" role="banner"><div class="content_knG7 announcementBarContent_xLdY">Support Ukraine 🇺🇦 <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">CacheLib</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/installation">Build and Installation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">User Guide</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_User_Guides/Cachebench_Overview">Cachebench</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Architecture Guide</a><a class="navbar__item navbar__link" href="/">‌</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/learnmore/">Learn More</a><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Architecture Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Overview</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/ram_cache_design">RAM Cache</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/ram_cache_design">RAM Cache Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/ram_cache_indexing_and_eviction">RAM cache indexing and eviction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/slab_rebalancing">Slab Rebalancing - How Does It Work?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/synchronization_in_eviction_and_slab_rebalancing">Synchronization between Eviction &amp; Slab-movement</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/compact_cache_design">Compact Cache Design</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/hybrid_cache">Hybrid Cache</a></div></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Architecture Guide</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">RAM Cache</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Synchronization between Eviction &amp; Slab-movement</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Synchronization between Eviction &amp; Slab-movement</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a class="hash-link" href="#overview" title="Direct link to heading">​</a></h2><p>There are two paths in CacheAllocator that manages the item memory ownership: eviction &amp; slab-movement. When the cache is full, a user’s allocation will trigger an eviction of an item to free up space for the new allocation. When CacheLib decides to move a slab, we will attempt to move or evict all the items that are currently active in the slab. We won’t discuss why slab movement is necessary. Instead we focus on how synchronization is handled between these two code-paths in CacheAllocator.</p><p>Eviction and slab-movement synchronize on an item’s exclusive bit. For chained items, the synchronization happens on its parent item’s exclusive bit.</p><p>What is the exclusive bit? This refers to one of the bits in an item’s header. A CacheLib item (cachelib/allocator/CacheItem.h) looks like the following.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">---------------------</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| Intrusive Hooks   |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| Reference &amp; Flags |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| Creation Time     |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| Expiry Time       |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| Payload           |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">---------------------</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Item header refers to all fields above Payload. An item’s ownership management happens within the “Reference &amp; Flags” field (cachelib/allocator/Refcount.h). Its purpose is as follows.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">  /**</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   * Layout of refcount type. This includes the flags, admin ref bits, and</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   * refcount. Admin ref encodes special reference counts that contain</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   * information on who holds the reference count (like AccessContainer or</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   * MMContainer). Flags encode item state such as whether or not it&#x27;s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   * a chained item.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   *</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   * The layout is as follows.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   * |-- flags --|-- admin ref --|-- access ref--|</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   * - Flags:  11 bits</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   * - Admin Ref: 3 bits</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   * - Access Ref: 18 bits</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The exclusive bit (kExclusive) and isInMMContainer (kLinked) are what we use to synchronize on an item for moving and eviction. They’re part of the Admin Ref. When we mention refcounts, we typically mean Access Ref. These 18 bits are used to count how many outstanding handles there’re for a given item.</p><p><strong>The following table shows when an item can enter into one of the following states.</strong></p><table><tr><td></td><td>Unlinked (not yet inserted in cache)</td><td>Linked &amp; Refcount &gt; 0 (being accessed by someone else)</td><td>Linked &amp; Refcount == 0 (currently not being accessed by anyone)</td><td>Exclusive</td><td>Moving</td></tr><tr><td>incRef</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>No</td></tr><tr><td>markForEviction</td><td>No</td><td>No</td><td>Yes</td><td>No</td><td>No</td></tr><tr><td>markMoving</td><td>No</td><td>No</td><td>Yes</td><td>No</td><td>No</td></tr></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="regular-items">Regular Items<a class="hash-link" href="#regular-items" title="Direct link to heading">​</a></h2><p>There are three ways a regular item’s life-cycle is affected when it is in DRAM cache.</p><ol><li>User or an internal cachelib thread <strong>acquiring</strong> a refcount on an item. (incRef)</li><li>User or an internal cachelib thread marking an item for <strong>eviction</strong>. (markForEviction)</li><li>An internal cachelib thread marking an item for <strong>moving</strong>. (markMoving)</li></ol><p><img loading="lazy" alt="alt_text" src="/assets/images/synchronization_in_eviction_and_slab_rebalancing_regular_item-9bfb28eb51bf5b9b6d7e7e24991aa78c.png" title="synchronization_in_eviction_and_slab_rebalancing_regular_item" width="556" height="822" class="img_ev3q"></p><p>Let’s now look at all the different scenarios the above operations can interact with one another.</p><p><strong>Eviction racing against Acquire</strong></p><ol><li>Thread-A: user attempting to acquire an item handle for Foobar</li><li>Thread-B: user attempting to evict Foobar to make space for another allocation</li><li>{Thread-A | Thread-B} wins<ol><li>Thread-A wins. Thread-B will skip Foobar and look for another item for eviction.</li><li>Thread-B wins. Thread-A will get a cache miss. This is fine because Foobar is now guaranteed to be freed and will not be visible to any users.</li></ol></li></ol><p><strong>Moving racing against Acquire</strong></p><ol><li>Thread-A: user attempting to acquire an item handle for Foobar</li><li>Thread-B: cachelib internal thread attempting to move Foobar to another memory location</li><li>{Thread A | Thread-B} wins<ol><li>Thread-A wins. Thread-B will retry indefinitely until it’s able to mark Foobar as moving, or if markMoving returns false which indicates the item had already been freed. The latter scenario can happen if Thread-A acquires the item handle first, removes it from the cache, and then drops the handle (if refcount == 0, the item will then be freed).</li><li>Thread-B wins. Thread-A will get an async ItemHandle back. This handle will become available when Foobar is successfully moved to another memory location, or evicted in which case the handle will return a cache miss.</li></ol></li></ol><p><strong>Eviction racing against Moving</strong></p><ol><li>Thread-A: cachelib internal thread attempting to move Foobar to another memory location</li><li>Thread-B: user attempting to evict Foobar to make space for another allocation</li><li>{Thread A | Thread-B} wins<ol><li>Thread-A wins. Thread-B will skip Foobar and look for another item for eviction.</li><li>Thread-B wins. Thread-A will retry until Foobar is evicted, after which point markMoving will return false, indicating the item had already been freed. Thread-B will skip this item and proceed to move the next item in the slab.</li></ol></li></ol><p><strong>Eviction, Moving, Acquire all racing against each other</strong></p><ol><li>Thread-A: user attempting to acquire an item handle for Foobar</li><li>Thread-B: cachelib internal thread attempting to move Foobar to another memory location</li><li>Thread-C: user attempting to evict Foobar to make space for another allocation</li><li>{Thread A | Thread B | Thread C} wins<ol><li>Thread-A loses to C. User gets a cache miss.</li><li>Thread-A loses to B. User gets a wait-context backed ItemHandle. Handle will be ready after B completes.</li><li>Thread-B loses. Retry indefinitely until Foobar can be marked moving or it had already been freed.</li><li>Thread-C loses. Skip Foobar and look for another item for eviction.</li></ol></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chained-items">Chained Items<a class="hash-link" href="#chained-items" title="Direct link to heading">​</a></h2><p>There are five ways a chained item’s life-cycle is affected when it is in DRAM cache.</p><ol><li>User or an internal cachelib thread <strong>acquiring</strong> a refcount on an item.</li><li>User or an internal cachelib thread marking an item for <strong>eviction</strong>.</li><li>An internal cachelib thread marking an item for <strong>moving</strong>.</li></ol><p>First three are very similar to regular item with two key differences:</p><ul><li><strong>The synchronization point of a chained item’s lifecycle is through its parent.</strong><ul><li>The above operations can happen on different chained items belonging to the same chain. But they will still race against one another via the parent of the chained item.</li></ul></li><li><strong>They also synchronize on the key’s corresponding chained item lock.</strong></li></ul><p><img loading="lazy" alt="alt_text" src="/assets/images/synchronization_in_eviction_and_slab_rebalancing_chained_item_1-8c7d020564d41792ade1d96b76ac35f5.png" title="synchronization_in_eviction_and_slab_rebalancing_chained_item_1" width="768" height="974" class="img_ev3q"></p><p>The last two scenarios are new just for chained items. Instead of the parent item’s exclusive bit, they synchronize on the key’s corresponding chained item lock.</p><ol start="4"><li>User <strong>adding/removing/replacing</strong> a chained item for the same parent item.</li><li>User or an internal cachelib thread <strong>transferring ownership</strong> of the chain to a new parent item.</li></ol><p><img loading="lazy" alt="alt_text" src="/assets/images/synchronization_in_eviction_and_slab_rebalancing_chained_item_2-3ac5ac97b16f7461ed5149763e4d1b61.png" title="synchronization_in_eviction_and_slab_rebalancing_chained_item_2" width="1152" height="856" class="img_ev3q"></p><p>Let’s now look at all the different scenarios the above operations can interact with one another.</p><p><strong>Eviction racing against Acquire</strong></p><p>Same as a regular item but everything is synchronized via parent item.</p><p><strong>Moving racing against Acquire</strong></p><p>Same as a regular item but everything is synchronized via parent item.</p><p><strong>Eviction racing against Moving</strong></p><p>Same as a regular item but everything is synchronized via parent item.</p><p><strong>Eviction, Moving, Acquire all racing against each other</strong></p><p>Same as a regular item but everything is synchronized via parent item.</p><p><strong>Transfer-Ownership racing against Eviction</strong></p><ol><li>Thread-A: user or an internal thread attempting to transfer the chain to a new copy of Foobar</li><li>Thread-B: user attempting to evict Foobar to make space for another allocation</li><li>{Thread-A | Thread-B} wins<ol><li>Thread-A wins.<ol><li>Thread-A has the handle to old Foobar and has not yet transferred the chain. Thread-B cannot mark old Foobar as exclusive and will skip it to find another item to evict.</li><li>Thread-A has already transferred the chain and dropped the old Foobar handle. Thread B will not come across old copy of Foobar as it will have been freed already.</li></ol></li><li>Thread-B wins. This can only happen if Thread-A has not yet looked up Foobar. After eviction, Thread-A will get a miss.</li></ol></li></ol><p><strong>Transfer-Ownership racing against Moving</strong></p><ol><li>Thread-A: user or an internal thread attempting to transfer the chain to a new copy of Foobar</li><li>Thread-B: cachelib internal thread attempting to move Foobar to another memory location</li><li>{Thread-A | Thread-B} wins<ol><li>Thread-A wins.<ol><li>Thread-A has the handle to old Foobar and has not yet transferred the chain. Thread-B cannot mark old Foobar as moving and will retry until the chain is transferred. After that it will be the same as the case below.</li><li>Thread-A has already transferred the chain and dropped the old Foobar handle. Thread B will call markMovingForSlabRelease and realize the old copy of Foobar has already been freed. So it will proceed to skip to the next item to move in the slab.</li></ol></li><li>Thread-B wins. This can only happen if Thread-A has not yet looked up Foobar. After moving, Thread-A will look up and get the newest copy and proceed the rest in the normal case.</li></ol></li></ol><p><strong>Chain-Add/Remove/Replace racing against Eviction</strong></p><ol><li>Thread-A: user or an internal thread add/remove/replace a chained item</li><li>Thread-B: user attempting to evict Foobar to make space for another allocation</li><li>{Thread-A | Thread-B} wins<ol><li>Thread-A wins.<ol><li>Thread-A has the handle of Foobar and has not done anything to the chain yet. Thread-B cannot mark old Foobar as exclusive and will skip it to find another item to evict.</li><li>Thread-A has finished operating on the chain and has dropped the handle of Foobar. Thread B will evict Foobar and its chained items.</li></ol></li><li>Thread-B wins. This can only happen if Thread-A has not yet looked up Foobar. After eviction, Thread-A will get a miss.</li></ol></li></ol><p><strong>Chain-Add/Remove/Replace racing against Moving</strong></p><ol><li>Thread-A: user or an internal thread add/remove/replace a chained item</li><li>Thread-B: cachelib internal thread attempting to move Foobar to another memory location</li><li>{Thread-A | Thread-B} wins<ol><li>Thread-A wins.<ol><li>Thread-A has the handle of Foobar and has not done anything to the chain yet. Thread-B cannot mark old Foobar as moving and will retry until Thread-A has completed.</li><li>Thread-A has finished operating on the chain and has dropped the handle of Foobar. Thread B will move Foobar and transfer its chained items to the new parent.</li></ol></li><li>Thread-B wins. This can only happen if Thread-A has not yet looked up Foobar. After moving, Thread-A will look up and get the newest copy of the parent and proceed the rest in the normal case.</li></ol></li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/CacheLib/edit/main/website/docs/Cache_Library_Architecture_Guide/Synchronization_In_Eviction_And_Slab_Rebalacing.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Cache_Library_Architecture_Guide/slab_rebalancing"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Slab Rebalancing - How Does It Work?</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Cache_Library_Architecture_Guide/compact_cache_design"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Compact Cache Design</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#regular-items" class="table-of-contents__link toc-highlight">Regular Items</a></li><li><a href="#chained-items" class="table-of-contents__link toc-highlight">Chained Items</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Reach Us</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.facebook.com/cachelib/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Developer Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/MetaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright © 2025 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c10705de.js"></script>
<script src="/assets/js/main.a9e49b72.js"></script>
</body>
</html>