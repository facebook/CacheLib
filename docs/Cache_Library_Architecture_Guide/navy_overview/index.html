<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Cache_Library_Architecture_Guide/navy_overview">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Navy Overview | CacheLib</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-rh="true" name="twitter:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-rh="true" property="og:url" content="https://cachelib.org/docs/Cache_Library_Architecture_Guide/navy_overview"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Navy Overview | CacheLib"><meta data-rh="true" name="description" content="Navy is the SSD optimized cache engine leveraged for Hybrid Cache. Navy is plugged into cachelib via the nvmcache interface and turned on by NavyConfig."><meta data-rh="true" property="og:description" content="Navy is the SSD optimized cache engine leveraged for Hybrid Cache. Navy is plugged into cachelib via the nvmcache interface and turned on by NavyConfig."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/navy_overview"><link data-rh="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/navy_overview" hreflang="en"><link data-rh="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/navy_overview" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CacheLib RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CacheLib Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="CacheLib" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.9576b86a.css">
<link rel="preload" href="/assets/js/runtime~main.c10705de.js" as="script">
<link rel="preload" href="/assets/js/main.a9e49b72.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script>

<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#20232a;color:#fff" role="banner"><div class="content_knG7 announcementBarContent_xLdY">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">CacheLib</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/installation">Build and Installation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">User Guide</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_User_Guides/Cachebench_Overview">Cachebench</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Architecture Guide</a><a class="navbar__item navbar__link" href="/">â€Œ</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/learnmore/">Learn More</a><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Architecture Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Overview</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/ram_cache_design">RAM Cache</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/hybrid_cache">Hybrid Cache</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/hybrid_cache">Hybrid Cache</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/navy_overview">Navy Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/small_object_cache">Small Object Cache</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/large_object_cache">Large Object Cache</a></li></ul></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Architecture Guide</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Hybrid Cache</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Navy Overview</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Navy Overview</h1></header><p>Navy is the SSD optimized cache engine leveraged for Hybrid Cache. Navy is plugged into cachelib via the <code>nvmcache</code> interface and turned on by <a href="/docs/Cache_Library_User_Guides/Configure_HybridCache/">NavyConfig</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="features">Features<a class="hash-link" href="#features" title="Direct link to heading">â€‹</a></h2><ul><li>Manages terabytes of data</li><li>Efficiently supports both small (~100 bytes) and large (~10KBs to ~1 MBs) objects</li><li>Sync and async API (supports custom executors for async ops)</li><li>Cache persistence on safe shutdown</li><li>Comprehensive cache stats</li><li>Different admission policies to optimize write endurance, hit ratio, IOPS</li><li>Supports Direct IO and raw devices</li><li>Supports async IO with either <a href="https://lwn.net/Articles/776703/" target="_blank" rel="noopener noreferrer">io_uring</a> or libaio</li><li>Supports Flexible Data Placement (FDP) to improve write endurance of the device</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="design-overview">Design overview<a class="hash-link" href="#design-overview" title="Direct link to heading">â€‹</a></h2><p>There are three over-arching goals in the design of Navy</p><ol><li>efficient caching for billions of small (\&lt;1KB) and millions of large objects (1KB - 16MB)  on SSDs.</li><li>read optimized point lookups</li><li>low DRAM overhead</li></ol><p>Since Navy is designed for a cache, it chooses to sacrifice the durability of data when it enables the accomplishment of the goals above. Caches are effective by constantly churning through the items based on popularity, making them write intensive. Since <strong>write-endurance</strong> is a constraint for NVM, the design of Navy optimizes for write-endurance as well.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture-overview">Architecture overview<a class="hash-link" href="#architecture-overview" title="Direct link to heading">â€‹</a></h2><p>Below figure shows the main components of Navy engine.</p><p><img loading="lazy" src="/assets/images/navy_architecture-04f7e32f458b3c4cc0e9c708226bc448.png" width="734" height="846" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="engine-driver">Engine Driver<a class="hash-link" href="#engine-driver" title="Direct link to heading">â€‹</a></h3><p>The engine driver is a simple layer providing the NVM cache interface (i.e., <code>AbstractCache</code>) to DRAM cache.</p><p>Other than that, the <code>Driver</code> is also responsible for performing admission control for insertion  and reinsertions (for BlockCache only). Specifically, the admission policy determines whether to accept items to NVM cache or not depending on different criteria or conditions in order to control the burn rate of the SSD or optimize the NVM cache usage for hit rate or overhead.</p><p>There are two levels of admission policies employed; NVM admission policy and Navy admission policy.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="nvm-admission-policy">NVM Admission Policy<a class="hash-link" href="#nvm-admission-policy" title="Direct link to heading">â€‹</a></h4><p>The <a href="/docs/Cache_Library_User_Guides/Configure_HybridCache/#admission">NVM admission policy</a> is mainly to optimize the NVM space usage (for, e.g., higher hit ratio) and the user can provide an arbitrary admission policy implementation.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="navy-admission-policy">Navy Admission Policy<a class="hash-link" href="#navy-admission-policy" title="Direct link to heading">â€‹</a></h4><p>The <a href="/docs/Cache_Library_User_Guides/Configure_HybridCache/#4-admission-policy-settings">Navy admission policy</a> is more focused on controlling the burn rate of the SSD by rejecting items randomly for optimizing the endurance of SSD and IOPS. Currently, Navy implements the following Navy admission policy mechanisms that can be enabled:</p><ol><li><code>RejectRandomAP</code>: Writes are probabilistically rejected based on a configured probabilty.<ul><li>This policy just rejects P% of inserts, picking victims randomly. This policy lets user to reduce the write rate (and so, increase flash lifetime).</li></ul></li><li><code>DynamicRandomAP</code>: Tracks the bytes written at device level and ensures the daily budget is under a specified write rate. This is done by doing probabilistic rejection where the rejection probability is updated every X seconds based on the bytes written so far and the budget available for the future. To support this, the bytes written from <code>Device</code> is plumbed into the admission policy.<ul><li>This is smart <code>RejectRandomAP</code>. User specifies maximum amount of data that can be written to the device per day. Policy monitors write traffic and as it grows beyond target (how much can be written up to this time of the day) it starts randomly reject inserts. It prefers to reject larger items to make hit ratio better. This behavior is tunable. It allows user ultimately control flash wear out.</li></ul></li></ol><p>There are also several parameters that can affect whether the item will be rejected:</p><ul><li><code>MaxConcurrentInserts</code>: writes are rejected once the number of the outstanding inserts including those queued for spooling reached the specified limit</li><li><code>MaxParcelMemory</code>: Each insert job has a memory footprint associated. Writes are rejected once the total amount of memory footprint for all outstanding inserts has reached the limit</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="job-scheduler">Job Scheduler<a class="hash-link" href="#job-scheduler" title="Direct link to heading">â€‹</a></h3><p><code>Driver</code> enqueues the API request as a <code>Job</code> to the <code>JobScheduler</code>. The jobs can be one of the following types; <code>JobType::Read</code> for jobs corresponding to read APIs for Navy (i.e., lookups), <code>JobType::Write</code> for jobs corresponding to write APIs for Navy (inserts and deletes). <code>JobScheduler</code> is responsible for executing the jobs using its Navy threads.</p><p>In order to avoid data races, the job scheduler makes sure at most one job is running for each key via spooling; i.e., the succeeding jobs for the same key are spooled in a queue until the preceding (outstanding) job has been completed. This is important given the async nature of the navy API. With this guarantee, callers can make assumptions about the concurrency of operations once enqueued to navy. This is relevant to using  optimistic concurrency by <code>NvmCache</code> implementation.</p><p>For the time being, there are two types of the job scheduler provided; <code>OrderedThreadPoolScheduler</code> and <code>NavyRequestScheduler</code>. The difference is that <code>OrderedThreadPoolScheduler</code> runs jobs to completions (including retries), while <code>NavyRequestScheduler</code> schedules jobs fully asynchronously as <a href="https://github.com/facebook/folly/blob/main/folly/fibers/README.md" target="_blank" rel="noopener noreferrer"><code>Fiber</code></a> (i.e., lightweight application thread) to <code>FiberManager</code>. Since <code>NavyRequestScheduler</code> is more lightweight and scalable, <code>OrderedThreadPoolScheduler</code> will soon be deprecated.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="orderedthreadpoolscheduler-to-be-deprecated">OrderedThreadPoolScheduler (<em>to be deprecated</em>)<a class="hash-link" href="#orderedthreadpoolscheduler-to-be-deprecated" title="Direct link to heading">â€‹</a></h4><p>To order the jobs, <code>OrderedThreadPoolScheduler</code> shards the jobs based on its key into one of several fine grained shards (millions). There can be only one job executed for a given request ordering shard at any given time, and if there is already one being executed, the rest are queued up in a pending job queue. Once the ordering condition is met, Jobs are sharded to be enqueued into one of several <code>JobQueue</code>.</p><p>The <code>OrderedThreadPoolScheduler</code> has two executor thread pools (read and write) and Jobs are sharded by key to the appropriate thread pools. Except <code>JobType::Read</code> all other jobs are executed by the writer pool. Each  thread in the pool has a corresponding <code>JobQueue</code> and a dedicated thread associate with processing its jobs.</p><p>Jobs are processed in FIFO manner and always run to completion, meaning any blocking of a job execution (e.g., for device IO) will block the whole thread until being unblocked.</p><p>Jobs can also be retried based on their exit status returned from the implementation. For example, when performing an insert, the job returns to scheduler with returning RETRY if there is no space left for insertion, so that the scheduler can invoke it again later for retry. Jobs are always enqueued to the back of their queue for retry.
<img loading="lazy" src="/assets/images/Job_Scheduler-445b781038884832fe0396958a9a7f20.png" width="1770" height="1518" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="navyrequestscheduler">NavyRequestScheduler<a class="hash-link" href="#navyrequestscheduler" title="Direct link to heading">â€‹</a></h4><p>To order the jobs, <code>NavyRequestScheduler</code> also uses the same mechanism as <code>OrderedThreadPoolScheduler</code>. I.e., <code>NavyRequestScheduler</code> shards the jobs based on its key into one of several fine grained shards (millions) and make sure only one job is outstanding by spooling jobs on the shard-specific pending queue.</p><p>The <code>NavyRequestScheduler</code> also has two executor thread pools (read and write) and Jobs are sharded by key to the appropriate thread pools. Except <code>JobType::Read</code> all other jobs (i.e., insert and delete) are executed by the writer pool.</p><p>However, unlike <code>OrderedThreadPoolScheduler</code>, <code>NavyRequestScheduler</code> schedules jobs simply submitting the job as a fiber to the <a href="https://github.com/facebook/folly/blob/main/folly/fibers/README.md" target="_blank" rel="noopener noreferrer"><code>FiberManager</code></a> that are driven by the Navy worker thread. The jobs are dispatched to workers in the pool in round-robin manner.</p><p>Since the jobs are running as a fiber, the job is simply descheduled on blocking for mutex (<a href="https://github.com/facebook/folly/blob/main/folly/fibers/TimedMutex.h" target="_blank" rel="noopener noreferrer">TimedMutex</a> which is fiber compatible) and the <code>FiberManager</code> schedules the next fiber in the <code>FiberManager</code> queue. Note that this needs to be paired with appropriate async IO engines at <code>Device</code> layer to run the Navy jobs fully async. Below figure shows the queuing architecture of async navy and io operation using <a href="https://github.com/facebook/folly/blob/main/folly/experimental/io/IoUring.h" target="_blank" rel="noopener noreferrer">IoUring</a>.</p><p><img loading="lazy" src="/assets/images/navy_async_io-1b23df02a16d8f40eaeddc0f6cd3a639.png" width="1710" height="534" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="engine">Engine<a class="hash-link" href="#engine" title="Direct link to heading">â€‹</a></h3><p>The engine is the core of Navy and implements actual NVM caching algorithms. In order to support wide range of item sizes, Navy provides two types of engines (i.e., <code>BigHash</code> and <code>BlockCache</code>) which are paired as <code>EnginePair</code>. The user can configure multiple <code>EnginePair</code>s on a same <code>Device</code> for space isolation purposes, where <code>EnginePair</code> serves as analogous to the pool for DRAM cache. The user can provide the engine pair selector to decide which <code>EnginePair</code> to be used for given item.</p><p><img loading="lazy" src="/assets/images/navy_engine_pair-bf1f56910441a2b674b2139c499f2b30.png" width="1040" height="688" class="img_ev3q"></p><p>BigHash is an engine to store small items (less than device block size). Block Cache (BC) is an engine to store large items (about or greater than device block size). Engines operate independently. The user can set the maximum item size for BigHash which is then used to determine which engine to use to insert items.</p><p>This implies that items can be cached in either the small or the large item engine depending on their size. While, size is known during insert, lookups and deletes don&#x27;t, and hence must check both engines before concluding. Specifically, for lookup, driver performs the lookup in the Large Item engine first and upon a miss, it performs the another lookup on the small item engine. For delete, driver performs the delete to both the small and large item engines.</p><p>Besides this, there are no high level locks per key to synchronize concurrent operations across both the engines.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bighash">BigHash<a class="hash-link" href="#bighash" title="Direct link to heading">â€‹</a></h4><p>BigHash is effectively a giant fixed-bucket hash map on the device. To read or write, the entire bucket is read (in case of write, updated and written back). Bloom filter used to reduce number of IO. When bucket is full, items evicted in FIFO manner. You don&#x27;t pay any RAM price here (except Bloom filter, which is 2GB for 1TB BigHash, tunable).</p><p>Read more in <a href="/docs/Cache_Library_Architecture_Guide/small_object_cache">Small Object Cache</a></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="block-cache">Block Cache<a class="hash-link" href="#block-cache" title="Direct link to heading">â€‹</a></h4><p>On the other hand, BlockCache divides device into equally sized regions (16MB, tunable) and fills a region with items of arbitrary sizes in append only manner.</p><p>BlockCache stores compact index in memory: key hash to offset. We do not store full key in memory and if collision happens (super rare), old item will look like evicted. In your calculations, use 12 bytes overhead per item to estimate RAM usage. For example, if your average item size is 4KB and cache size is 500GB you&#x27;ll need around 1.4GB of memory.</p><p>Since BlockCache stores insert data in append manner to the active regions, it requires to perform the reclaim (a.k.a. garbage collection), which basically select a region and reinsert or evict still valid items. The reclaims are performed by one or more of dedicated threads called <code>region_manager</code> threads when the number of reserved clean regions go below the threshold (e.g., 10). Usually, one <code>region_manager</code> should be enough for most of the use cases, but need to be increased if needed.</p><p>Read more in <a href="/docs/Cache_Library_Architecture_Guide/large_object_cache">Large Object Cache</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="device">Device<a class="hash-link" href="#device" title="Direct link to heading">â€‹</a></h3><p><code>Device</code> is an abstraction of the backing NVM cache storage and provides APIs to read and write data onto the backing storage.</p><p>All IO operations within Navy happen over a range of block offsets. <code>Device</code> provides a virtual interface for reads and writes into these offsets. Underneath, the Device could be either a <code>FileDevice</code> implementation over one or more regular or raw block device files or an <code>InMemoryDevice</code> using a malloc-ed buffer (for testing). <code>Device</code> aligns all reads  from its calles to <code>ioalignSize</code> that is used to configured the <code>Device</code> and trims any extra data that is read.  <code>Device</code> also handles opaque functionality like encryption, chunking, latency measurements for reading and writing while delegating the actual reads or writes to underlying implementation.</p><p><strong>Encryption</strong>: <code>Device</code> can be initialized with a <code>DeviceEncrytor</code> to support block level encryption. All reads and writes pass through the encryption layer and is done at the granularity of encryption block size. Usually the block size for encryption is as small as 4KB. The IO alignment for reads and writes must match the block size used for encryption.</p><p><strong>Chunking</strong>:  Large writes (MBs) can cause head of line blocking for reads on SSDs. To avoid the negative impact on the tail latency for reads, <code>Device</code> can be configured to break up writes into chunks and issue them sequentially. While this can increase the latency for writes, read latency can be improved. Reads are not broken into chunks.</p><p><strong>LatencyTracking</strong>: Device also tracks the overall latency for reads and writes in a uniform way across all implementations of Device.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="filedevice">FileDevice<a class="hash-link" href="#filedevice" title="Direct link to heading">â€‹</a></h4><p><code>FileDevice</code> implements <code>Device</code> over one or more regular or block device files. When multiple regular or block devices are used, <code>FileDevice</code> operates like a software RAID-0 where a single IO can be splitted into multiple IOs in the unit of fixed <code>stripe</code> size.  Note, this striping is orthogonal to the chunking that happens with <code>Device</code>. Usually, the stripe size is set to the size of a Navy region(16-64MB).</p><p>For actual IO operations, <code>FileDevice</code> supports both sync and async operations. For async operations, <code>FileDevice</code> supports <a href="https://lwn.net/Articles/776703/" target="_blank" rel="noopener noreferrer"><code>io_uring</code></a> and <code>libaio</code> which are supported by <a href="https://github.com/facebook/folly" target="_blank" rel="noopener noreferrer">folly</a> as <code>folly::IoUring</code> and <code>folly::AsyncIO</code>, respectively.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fdpnvme">FdpNvme<a class="hash-link" href="#fdpnvme" title="Direct link to heading">â€‹</a></h4><p><code>FdpNvme</code> embeds the FDP semantics and specific IO handling. IO with FDP semantics need to be sent through the io_uring_cmd interface and <code>FdpNvme</code> implements interfaces to allocate FDP specific <code>placementHandle</code>s, to prepare the UringCmd Sqe, etc. When FDP is enabled, <code>FileDevice</code> makes use of <code>FdpNvme</code> to use the FDP enabled file device path. For more informtaion read <a href="/docs/Cache_Library_User_Guides/FDP_enabled_Cache">FDP enabled Cache</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/CacheLib/edit/main/website/docs/Cache_Library_Architecture_Guide/Navy_Overview.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Cache_Library_Architecture_Guide/hybrid_cache"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Hybrid Cache</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Cache_Library_Architecture_Guide/small_object_cache"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Small Object Cache</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#features" class="table-of-contents__link toc-highlight">Features</a></li><li><a href="#design-overview" class="table-of-contents__link toc-highlight">Design overview</a></li><li><a href="#architecture-overview" class="table-of-contents__link toc-highlight">Architecture overview</a><ul><li><a href="#engine-driver" class="table-of-contents__link toc-highlight">Engine Driver</a></li><li><a href="#job-scheduler" class="table-of-contents__link toc-highlight">Job Scheduler</a></li><li><a href="#engine" class="table-of-contents__link toc-highlight">Engine</a></li><li><a href="#device" class="table-of-contents__link toc-highlight">Device</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Reach Us</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.facebook.com/cachelib/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Developer Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/MetaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2025 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c10705de.js"></script>
<script src="/assets/js/main.a9e49b72.js"></script>
</body>
</html>