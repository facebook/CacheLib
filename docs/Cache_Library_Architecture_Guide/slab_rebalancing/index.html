<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Cache_Library_Architecture_Guide/slab_rebalancing">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Slab Rebalancing - How Does It Work? | CacheLib</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-rh="true" name="twitter:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-rh="true" property="og:url" content="https://cachelib.org/docs/Cache_Library_Architecture_Guide/slab_rebalancing"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Slab Rebalancing - How Does It Work? | CacheLib"><meta data-rh="true" name="description" content="Goal"><meta data-rh="true" property="og:description" content="Goal"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/slab_rebalancing"><link data-rh="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/slab_rebalancing" hreflang="en"><link data-rh="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/slab_rebalancing" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CacheLib RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CacheLib Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="CacheLib" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.9576b86a.css">
<link rel="preload" href="/assets/js/runtime~main.484ad1ea.js" as="script">
<link rel="preload" href="/assets/js/main.a9e49b72.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script>

<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#20232a;color:#fff" role="banner"><div class="content_knG7 announcementBarContent_xLdY">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">CacheLib</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/installation">Build and Installation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">User Guide</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_User_Guides/Cachebench_Overview">Cachebench</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Architecture Guide</a><a class="navbar__item navbar__link" href="/">â€Œ</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/learnmore/">Learn More</a><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Architecture Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Overview</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/ram_cache_design">RAM Cache</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/ram_cache_design">RAM Cache Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/ram_cache_indexing_and_eviction">RAM cache indexing and eviction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/slab_rebalancing">Slab Rebalancing - How Does It Work?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/synchronization_in_eviction_and_slab_rebalancing">Synchronization between Eviction &amp; Slab-movement</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/compact_cache_design">Compact Cache Design</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/hybrid_cache">Hybrid Cache</a></div></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Architecture Guide</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">RAM Cache</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Slab Rebalancing - How Does It Work?</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Slab Rebalancing - How Does It Work?</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="goal">Goal<a class="hash-link" href="#goal" title="Direct link to heading">â€‹</a></h2><p>This doc will explain in depth how slab rebalancing works in RAM cache. We will cover the following aspects:</p><ol><li>Why do we need to rebalance?</li><li>How do we pick a slab to release?</li><li>How do we maintain strict LRU ordering during a slab release?</li><li>How do we handle chained items when they&#x27;re spread across multiple slabs?</li><li>What is the synchronization mechanism during a slab release?</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-overview">High Level Overview<a class="hash-link" href="#high-level-overview" title="Direct link to heading">â€‹</a></h2><p><img loading="lazy" src="/assets/images/slab-rebalancing-overview-372d540c5324d4bf46c88712896457b0.png" width="1509" height="860" class="img_ev3q">
Slab rebalancing is the act of moving one slab from one allocation class to another. CacheLib allocates memory from a slab allocator in which we assign one allocation class (also known as slab class) for each size granularity. When cache becomes full, for a particular allocation size user requests, CacheLib evicts an item of the same size granularity and returns the recycled memory back to the user. Due to this design, it is important to balance the numbers of slabs in each allocation class. Issues such as allocation failures or unexpected imbalance between eviction ages of different sized objects can happen when user requests a lot of items of a particular size, but the allocation class for that size has very few numbers of slabs.</p><p>To rebalance, we first pick a slab from an allocation class, and then evict or move each item in the slab. After that, we can free this slab, and give it to another allocation class. Slab rebalancing is an intra-pool operation. However, moving slabs between different memory pool (due to pool resizing) follows the same logical operations. Now, let&#x27;s walk through each step in slab rebalancing in details below.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="details">Details<a class="hash-link" href="#details" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-why-do-we-need-to-rebalance">1. Why do we need to rebalance<a class="hash-link" href="#1-why-do-we-need-to-rebalance" title="Direct link to heading">â€‹</a></h3><p><img loading="lazy" src="/assets/images/Slab-rebalancing-why-e28fbff53f8b49f20eff12817588a2db.png" width="2202" height="742" class="img_ev3q">
CacheLib allocates memory from a slab allocator in which we assign one allocation class (also known as slab class) for each size granularity. In the slab allocator design, memory is partitioned into a number of slabs. For CacheLib, each slab is 4MB. Each allocation class is responsible for allocating for a particular size granularity. In the beginning, none of the allocation classes have any memory. When an allocation request comes from the user, we will take one slab from the free slabs, and give it to an allocation class. Once the allocation class has at least one slab, it will start allocating contiguously at the size granularity. Once the allocation class has no more free slab left, it can ask for another from the free slabs. When free slabs run out, it will start evicting items to make space for a new allocation. Note that the evictions can happen within just one allocation class because each is paired with a LRU (or 2Q, or another eviction policy).</p><p><img loading="lazy" src="/assets/images/Slab-rebalancing-why-2-d1e46dbddfa877fc49ec3de422f3f012.png" width="2230" height="979" class="img_ev3q"></p><p>This design means that the number of slabs in each allocation class depends on the allocation request pattern before a cache is warmed up. In a hypothetical scenario, a use-case may request only 100-byte objects during the day and only 1000-byte objects during the night. This means with a naive slab allocator design, if we start up a new cache during the day, by the time night arrives, we do not have any available memory for 1000-byte objects, and are unable to evict anything because all items in the cache are 100-byte.</p><p><img loading="lazy" src="/assets/images/Slab-rebalancing-why-3-9eb9d958f0b4532b61a9a9382fb1ca0b.png" width="1367" height="881" class="img_ev3q"></p><p>For obvious reason, this is bad. The way to solve this issue is via slab rebalancing. We will move a slab from 100-byte allocation class to 1000-byte allocation class, so it has memory to evict. Next, let&#x27;s examine how we can pick a slab.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-how-do-we-pick-a-slab">2. How do we pick a slab<a class="hash-link" href="#2-how-do-we-pick-a-slab" title="Direct link to heading">â€‹</a></h3><p>There are several objectives for moving slabs around.</p><ol><li>Minimize allocation failures.</li><li>Ensure fairness in how long an object might stick around in cache.</li><li>Optimize the cache composition to drive the highest objectwise-hitrate.</li></ol><p>Note that 2 &amp; 3 are often times opposite goals. A cache may get a lot more &quot;get&quot; requests for objects within a certain size granularity, if we move as many slabs to that size to maximize the &quot;hits/byte&quot;, we will maximize objectwise hit rate, but at the expense of the cache retention time fairness for objects of a different size.</p><p>CacheLib offers four different rebalancing policies:</p><ul><li>RebalanceStrategy{} - Default policy. This addresses 1. It will only be triggered when we detect allocation failures.</li><li>LruTailAgeStrategy{} - This addresses 1 &amp; 2. It moves slab from AC with the highest &quot;eviction age&quot; to one with the lowest.</li><li>HitsPerSlabStrategy{} - This addresses 1 &amp; 3. It moves slab from AC with the lowest &quot;hits per slab&quot; to one with the highest. It assumes a linear relationship between hits and number of slabs.</li><li>MarginalHitsStrategy{} - This addresses 1 &amp; 3. It has the same goal as HitsPerSlabStrategy, but assumes a non-linear relationship. It tries to approximate the marginal return by using only the hits of the &quot;last slab&quot; of an AC to determine the increase in hits if it were to get another slab.</li></ul><p>Once we have picked an allocation class as a victim for giving up a slab, we will pick a slab at random (we do this by taking a slab from the end of the allocated slab list in an AC).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-how-do-we-maintain-strict-lru-ordering">3. How do we maintain strict LRU ordering<a class="hash-link" href="#3-how-do-we-maintain-strict-lru-ordering" title="Direct link to heading">â€‹</a></h3><p>Once we have picked a slab, we have to release it. CacheLib follows the following algorithm for slab release:</p><ol><li>Mark the slab as &quot;in slab release&quot;</li><li>Filter out all &quot;freed&quot; allocations in this slab</li><li>Walk through each &quot;active&quot; allocation</li><li>(two different algorithms)<ol><li>Evict this allocation</li><li>Maintain strict LRU ordering via memcpy (or user callback) the content of an item to another item by evicting from the tail of LRU in the same allocation class. (Note: if there&#x27;re any free items in the AC, we will first allocate from the free list)</li></ol></li><li>Once all done, free the slab</li></ol><p>Note that 4(a) is self-explanatory; we&#x27;re just evicting everything still active in this slab until the slab is devoid of any allocations still being used by the user. 4(b) is the more involved one as the goal here is to maintain strict lru ordering. The way it is done is as follows. User is responsible for choosing which algorithm to use for step 4. 4(b) is enabled if user specifies a moving callback (memcpy or some custom callback logic).</p><p><img loading="lazy" src="/assets/images/How-do-we-pick-slab-1c4bdce2c676786721a3b8c5c1c7736c.png" width="1869" height="897" class="img_ev3q"></p><p>When we evict from the tail of the LRU to make room for the item we&#x27;re &quot;moving&quot;. We make sure we only evict an item from another slab. Note we may actually evict an item that is in the same slab currently being released. This is fine as it is both rare and also that later on when we get to that item, we will move it again to a new allocation. The overall &quot;move&quot;s we complete are still bound by the number of active allocations in the slab.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-how-do-we-handle-chained-items">4. How do we handle chained items<a class="hash-link" href="#4-how-do-we-handle-chained-items" title="Direct link to heading">â€‹</a></h3><p>Chained items enable user to tie several allocations together to form a single lifetime. Conceptually, they&#x27;re a linked list of allocations. User first creates a parent item, which has a key, and is the head of a chain. Then user will create children items, which do not have a key, and append them to the parent one by one. Each allocation in the list can be of a different size. On eviction, we evict the entire chain. This poses a challenge to slab rebalancing. We must ensure when we choose to evict allocations during slab release, we must also evict any chained items to the allocations. Similarly, when we choose to &quot;move&quot; allocations during slab release, we must re-link any moved allocation to their chained items.
<strong>Eviction for Slab Release</strong></p><ol><li>Pick an allocation to evict</li><li>Check if this item is a parent or a child<ol><li>If parent, evict it directly which will also free the children</li><li>If child, find the parent and evict the parent</li></ol></li></ol><p><img loading="lazy" src="/assets/images/How-do-we-release-slab-31ee3cb90ff24b4280dfd6583ad7b489.png" width="2013" height="1034" class="img_ev3q"></p><p><strong>Moving for Slab Release</strong></p><ol><li>Pick an allocation to move</li><li>Check if this item is a parent or a child<ol><li>If parent, move it into a new allocation, and relink each of its children to it</li><li>If child, move it into a new allocation, and fix up the link from the previous child to the moved child</li></ol></li></ol><p><img loading="lazy" src="/assets/images/How-do-we-release-slab-2-29b89d7defeabb17c5e45bc5ac991ecf.png" width="2328" height="1179" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-how-do-we-synchronize">5. How do we synchronize<a class="hash-link" href="#5-how-do-we-synchronize" title="Direct link to heading">â€‹</a></h3><p>We synchronize all operations via atomic flags in each item&#x27;s header, and the use of eviction locks and chained item locks (if involving chained items). The goal of synchronization is to ensure the following:</p><ul><li>We&#x27;re the only thread that can evict an item (or a chain of items).</li><li>We&#x27;re the only thread that can mutate the content of an item (or a chain of items).</li></ul><p>During slab release, when we pick an allocation, we mark a bit in its header denoting that it is currently being operated on for slab release. This bit will prevent any other thread from evicting this item. Afterwards, if we&#x27;re freeing this allocation via a regular eviction (4(a) algorithm in section 3), we hold onto the eviction lock for its allocation class (the current allocation class), and also the eviction and chained item lock for its parent (if available, and can be of a different allocation class). This ensures the slab release thread is the only one that can evict this item and its chain if available.</p><p>Alternatively, if we&#x27;re moving this allocation (4(b) algorithm in section 4), we grab eviction lock and chained items similarly as above. But instead of evicting, we will grab an additional (and optional) user-level synchronization primitive (we call it movingSync). This primitive is supplied by our user and it is usually a read-write lock our users use to guard mutation into item content in their code. For obvious reason, we don&#x27;t need this for immutable workloads. Once we have the locks, we allocate a new item, call user callback to &quot;move&quot; the old item into the new item, and then fix up any links if involving chained items. Finally, we atomically swap the entry in the hash table so the new, &quot;moved&quot; item becomes visible to the user.</p><p>Finally, we will not &quot;recycle&quot;/&quot;free&quot;/&quot;evict&quot; an allocation in the slab until the refcount on the allocation has dropped to 0. This is to ensure that user who has looked up an item in the slab release before we removed it from the hash table can still use it safely. It also means in the case of any slowdown in user processing path involving an item in a slab release can slow down the slab release. This is an accepted design tradeoff, as slab release happens in the background and is not latency sensitive.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/CacheLib/edit/main/website/docs/Cache_Library_Architecture_Guide/Slab_Rebalancing_-_How_Does_It_Work.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Cache_Library_Architecture_Guide/ram_cache_indexing_and_eviction"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">RAM cache indexing and eviction</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Cache_Library_Architecture_Guide/synchronization_in_eviction_and_slab_rebalancing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Synchronization between Eviction &amp; Slab-movement</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#goal" class="table-of-contents__link toc-highlight">Goal</a></li><li><a href="#high-level-overview" class="table-of-contents__link toc-highlight">High Level Overview</a></li><li><a href="#details" class="table-of-contents__link toc-highlight">Details</a><ul><li><a href="#1-why-do-we-need-to-rebalance" class="table-of-contents__link toc-highlight">1. Why do we need to rebalance</a></li><li><a href="#2-how-do-we-pick-a-slab" class="table-of-contents__link toc-highlight">2. How do we pick a slab</a></li><li><a href="#3-how-do-we-maintain-strict-lru-ordering" class="table-of-contents__link toc-highlight">3. How do we maintain strict LRU ordering</a></li><li><a href="#4-how-do-we-handle-chained-items" class="table-of-contents__link toc-highlight">4. How do we handle chained items</a></li><li><a href="#5-how-do-we-synchronize" class="table-of-contents__link toc-highlight">5. How do we synchronize</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Reach Us</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.facebook.com/cachelib/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Developer Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/MetaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2025 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.484ad1ea.js"></script>
<script src="/assets/js/main.a9e49b72.js"></script>
</body>
</html>