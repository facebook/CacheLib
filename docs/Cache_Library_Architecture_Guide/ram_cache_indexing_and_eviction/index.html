<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Cache_Library_Architecture_Guide/ram_cache_indexing_and_eviction">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">RAM cache indexing and eviction | CacheLib</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-rh="true" name="twitter:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-rh="true" property="og:url" content="https://cachelib.org/docs/Cache_Library_Architecture_Guide/ram_cache_indexing_and_eviction"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="RAM cache indexing and eviction | CacheLib"><meta data-rh="true" name="description" content="This article takes a deep look at CacheLib&#x27;s RAM cache&#x27;s AccessContainer and"><meta data-rh="true" property="og:description" content="This article takes a deep look at CacheLib&#x27;s RAM cache&#x27;s AccessContainer and"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/ram_cache_indexing_and_eviction"><link data-rh="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/ram_cache_indexing_and_eviction" hreflang="en"><link data-rh="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/ram_cache_indexing_and_eviction" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CacheLib RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CacheLib Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="CacheLib" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.e26cc58b.css">
<link rel="preload" href="/assets/js/runtime~main.4ad039a1.js" as="script">
<link rel="preload" href="/assets/js/main.349c8c72.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script>

<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#20232a;color:#fff" role="banner"><div class="content_knG7 announcementBarContent_xLdY">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">CacheLib</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/installation">Build and Installation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">User Guide</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_User_Guides/Cachebench_Overview">Cachebench</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Architecture Guide</a><a class="navbar__item navbar__link" href="/">â€Œ</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/learnmore/">Learn More</a><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Architecture Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Overview</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/ram_cache_design">RAM Cache</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/ram_cache_design">RAM Cache Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/ram_cache_indexing_and_eviction">RAM cache indexing and eviction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/slab_rebalancing">Slab Rebalancing - How Does It Work?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/compact_cache_design">Compact Cache Design</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/hybrid_cache">Hybrid Cache</a></div></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Architecture Guide</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">RAM Cache</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">RAM cache indexing and eviction</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>RAM cache indexing and eviction</h1></header><p>This article takes a deep look at CacheLib&#x27;s RAM cache&#x27;s AccessContainer and
MMContainer, which powers the indexing and eviction of RAM cache.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="containers"><strong>Containers</strong><a class="hash-link" href="#containers" title="Direct link to heading">â€‹</a></h2><p>The word &quot;container&quot; in the names of AccessContainer and MMContainer refers to
<a href="https://stackoverflow.com/questions/5004162/what-does-it-mean-for-a-data-structure-to-be-intrusive" target="_blank" rel="noopener noreferrer">intrusive containers</a>.
For the purpose of understanding this article, the gist here is that the
container does not store a copy of the element. So an item in CacheLib can be
retrieved by both AccessContainer and MMContainer without duplicating copies.
This is achieved by storing some metadata in the item itself. The details would
be discussed in the sections below.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="accesscontainer"><strong>AccessContainer</strong><a class="hash-link" href="#accesscontainer" title="Direct link to heading">â€‹</a></h2><p>The AccessContainer is an intrusive hook based container and supports a
standard interface that works with CacheAllocator. It could be viewed as a
large hash table that serves as the index of the entire CacheLib cache. An
item&#x27;s accessibility is controlled only by the access container. So an item is
accessible (can be returned by find request) only after it is inserted into the
access container and is no longer accessible once it is removed from the access
container. There is only one access container for the entire CacheLib cache
(see <code>accessContainer_</code> in <code>cachelib/allocator/CacheAllocator.h</code>).</p><p>It has the following major API functions:</p><ul><li>find: Given a string key, return the item handle. This is used when the client calls find on a key.<ul><li>Example call-site: <code>CacheAllocator::findInternal</code>.</li></ul></li><li>insert: Insert an item handle into the AccessContainer, making it accessible
to future find requests. This is used when the client calls the
CacheAllocator&#x27;s inset API.<ul><li>Example call-site: <code>CacheAllocator::insertImpl</code>.</li></ul></li><li>remove: Remove an item from the AccessContainer, making it not accessible to
future find requests. This is used when the client removes an item from the
cache. This is also used when moving an item (more details on
<a href="/docs/Cache_Library_Architecture_Guide/slab_rebalancing">4. How do we handle chained items</a>).<ul><li>Example call-site: <code>CacheAllocator::removeImpl</code>.</li></ul></li></ul><p>The full API can be found in <code>ChainedHashTable::Container</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="chainedhashtable"><strong>CHAINEDHASHTABLE</strong><a class="hash-link" href="#chainedhashtable" title="Direct link to heading">â€‹</a></h3><p>This is our only implementation of access container.</p><p>The memory payload is a hash table (<em>ChainedHashTable::Container::ht_</em>), which
contains a list of compressed pointers (<code>ChainedHashTable::Impl::hashTable_</code>).
Each compressed pointer in this list (together with the compressor) points to
the head node of each bucket&#x27;s chain. In CacheLib cache, this node (the <code>type T</code> in
in type parameter for ChainedHashTable::Impl) is a CacheItem
(<code>allocator/CacheItem.h</code>). For CacheItem to be eligible as a node here, it needs
to meet the following criterium:</p><ul><li><p>Carries the hook (<code>accessHook_</code> in <code>cachelib/allocator/CacheItem.h</code>): This
hook is defined as <code>struct CACHELIB_PACKED_ATTR Hook</code> in
<code>cachelib/allocator/ChainedHashTable.h</code>, which points to the next item in the
bucket&#x27;s chain. This adds a compressed pointer to CacheItem&#x27;s payload.</p></li><li><p>Implements <code>isAccessible()</code>, <code>markAccessible()</code>, <code>unmarkAccessible()</code>. This
is backed by one bit in the CacheItem&#x27;s flags.</p></li><li><p>Implements <code>getKey()</code>. This doesn&#x27;t require extra memory, as the CacheItem
already store the key for other purpose.</p></li></ul><p>With the intrusive implementation, operations on this hash table is easy:</p><ul><li><p><code>find()</code>: Hash the key and get the bucket then iterate over the bucket chain
(<code>Handle find(Key key)</code> function in <code>cachelib/allocator/ChainedHashTable.h</code>).</p></li><li><p><code>insert()</code>: Find the bucket and replace the head with the node to be inserted
(<code>bool ChainedHashTable::Container&lt;...::insert(T&amp; node)</code> in <code>cachelib/allocator/ChainedHashTable-inl.h</code>).</p></li><li><p><code>remove()</code>: Find the bucket and remove the node from the chain
(<code>bool ChainedHashTable::Container&lt;T, HookPtr, LockT&gt;::remove(T&amp; node)</code> in <code>cachelib/allocator/ChainedHashTable-inl.h</code>).</p></li></ul><p>Find and remove requires iteration on the bucket chain but insert does not.
Note that remove requires the iteration on the chain not to locate the node
itself (as we have it from the API) but to find the previous item so that the
node can be removed from the linked list.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mmcontainer"><strong>MMContainer</strong><a class="hash-link" href="#mmcontainer" title="Direct link to heading">â€‹</a></h2><p>RAM evictions are controlled by MMContainers. It can be viewed as an eviction
algorithm powered by intrusive containers. When an item is inserted, it is
added into the MMContainer (e.g. entering the eviction queue). When an item is
accessed, it is recorded (e.g. promoted in LRU). When the cache allocator asks
for an item to evict, it returns an iterator for the next item to be evicted.
When the item is finally removed form the queue, it removes the item form the
queue. There is one MMContainer <strong>per allocation class in each
pool</strong> (see <code>mmContainers_</code> in <code>cachelib/allocator/CacheAllocator.h</code>).</p><p>It has the following major API functions:</p><ul><li><code>insert</code>: Add an item into the eviction queue. This is called when an item is
inserted into the cache. This can also happen when we are moving an item and we
need to remove it from one MMContainer and add to another
(<code>CacheAllocator&lt;CacheTrait&gt;::insertInMMContainer(Item&amp; item)</code> in
<code>cachelib/allocator/CacheAllocator-inl.h</code>).</li><li><code>record</code>: Record an access of the item. Typically this means promoting the
item in some form of LRU queue (<code>void
  CacheAllocator&lt;CacheTrait&gt;::recordAccessInMMContainer(Item&amp; item, AccessMode
  mode)</code> in <code>cachelib/allocator/CacheAllocator-inl.h</code>).</li><li><code>remove</code>: Remove an item from the eviction queue. This is called when an item
is removed form the cache (evicted or explicitly removed by the client) (<code>bool
  CacheAllocator&lt;CacheTrait&gt;::removeFromMMContainer(Item&amp; item)</code> in
<code>cachelib/allocator/CacheAllocator-inl.h</code>).</li><li><code>getEvictionIterator</code>: Return an iterator of items to be evicted. This is
called when the cache allocator is looking for eviction. Usually the first item
that can be evicted (no active handles, not moving, etc) is used (see
<code>CacheAllocator&lt;CacheTrait&gt;::findEviction(PoolId pid, ClassId cid)</code> in
<code>cachelib/allocator/CacheAllocator-inl.h</code>).</li><li><code>withEvictionIterator</code>: Executes callback with eviction iterator passed as a
parameter. This is alternative for <code>getEvictionIterator</code> that offers possibility
to use combined locking. Combined locking can be turned on by setting:
<code>useCombinedLockForIterators</code> config option.</li></ul><p>The full API can be found in <code>struct Container</code> in
<code>cachelib/allocator/MMLru.h</code>.  This links to MMLru, which is one of the
multiple MMContainers we implemented. All the operations above have constant
time complexity in each of the implementations.</p><p>The eviction requires an iterator instead of a single item because it is
possible that the item best for eviction is being referred to, moved, or for
some other reason can not be evicted. In this case, CacheAllocator advances the
iterator until a good victim is found or fails the eviction after too many
retries and further results in an allocation failrue.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dlist"><strong>DLIST</strong><a class="hash-link" href="#dlist" title="Direct link to heading">â€‹</a></h3><p>The multiple implementations of MMContainer all relies on the same intrusive
doubly-linked list implementation (<code>class DList</code> in <code>cachelib/allocator/datastruct/DList.h</code>).
The <em>hook</em> required by this is straightforward: just compressed pointers to the
next and previous item (<code>struct DListHook</code> in
<code>cachelib/allocator/datastruct/DList.h</code>).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lru"><strong>LRU</strong><a class="hash-link" href="#lru" title="Direct link to heading">â€‹</a></h3><p>[MMLru]<!-- -->(<code>class MMLru</code> in <code>cachelib/allocator/MMLru.h</code>) powers the LRU (see <a href="/docs/Cache_Library_User_Guides/eviction_policy/">lru</a>).</p><p>It is powered by a single DList, which holds the head and tail of the queue. It
also has a reference to <em>the insertion
point</em> (see <code> T* insertionPoint_{nullptr};</code> in <code>cachelib/allocator/MMLru.h</code>)
where new items are inserted. The operations are straightforward standard
linked list operation that takes constant time:</p><ul><li>Insert: A new item is inserted to the insertion point.</li><li>Record: A promoted item is moved to the head of the queue.</li><li>Remove: The item is removed from the queue.</li><li>Eviction iterator: An iterator pointing to the tail of the queue is returned and moves backward.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lru-2q"><strong>LRU-2Q</strong><a class="hash-link" href="#lru-2q" title="Direct link to heading">â€‹</a></h3><p>MM2Q powers <a href="/docs/Cache_Library_User_Guides/eviction_policy/#lru-2q">LRU2Q</a>.
It is powered by <code>MultiDList</code> (variable <code>LruList</code> in <code>struct Container</code> in <code>cachelib/allocator/MM2Q.h</code>).
Underneath, it contains 5 DLists: Hot, Warm, WarmTail, Cold, ColdTail.</p><ul><li>Insert: A new item is inserted to the head of the Hot queue.</li><li>Record:<ul><li>An item in Hot list is moved to the head of the Hot queue.</li><li>An item in Warm or WarmTail list is moved to the head of the Warm queue.</li><li>An item in Cold or ColdTail list is moved to the head of the Warm queue.</li></ul></li><li>Remove: The item is removed from the current queue.</li><li>Eviction iterator: An iterator goes from the tail of ColdTail backwards, then to Cold, WarmTail, Warm, Hot.</li></ul><p>The Tail lists are optional queues designed to supply statistics on access
counts on the last 1 slab worths of items on the Cold and Warm queue. This
stats can help us understand if assigning one more slab to this particular
allocation class would be a good tradeoff. The marginal hits policy of
rebalancing relies on this statistics (more details in <a href="/docs/Cache_Library_Architecture_Guide/slab_rebalancing">2. How do we pick a slab</a>).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tiny-lfu"><strong>TINY-LFU</strong><a class="hash-link" href="#tiny-lfu" title="Direct link to heading">â€‹</a></h3><p><code>class MMTinyLFU</code> (in <code>cachelib/allocator/MMTinyLFU.h</code>) powers
<a href="/docs/Cache_Library_User_Guides/eviction_policy/#tinylfu">Tiny-LFU</a>. This is an
implementation of W-TinyLFU cache eviction policy described in
<!-- -->[https://arxiv.org/pdf/1512.00727.pdf]<!-- -->.
The main cache and the tiny cache. The tiny cache is typically sized to be 1%
of the total cache with the main cache being the rest 99%. Both caches are
implemented using LRUs. New items land in tiny cache. During eviction, the tail
item from the tiny cache is promoted to main cache if its frequency is higher
than the tail item of of main cache, and the tail of main cache is evicted.
This gives the frequency based admission into main cache. Hits in each cache
simply move the item to the head of each LRU cache.</p><p>The frequency is maintained by <strong>count-min-sketch</strong> (<code>cachelib/common/CountMinSketch.h</code>)</p><ul><li>Insert: A new item is added into the Tiny queue<ul><li>If the Tiny queue&#x27;s size is larger than expected, promote the tail of the
Tiny queue into Main queue. Otherwise, swap the tails of the queues, if the
Tiny queue&#x27;s tail is more frequently accessed than the Main tail.</li><li>If the count-min-sketch is too small for the number of items in the queue, recreate the counters with doubled capacity.<ul><li>Note: if recreation happens, the existing frequency counts will be erased.</li></ul></li></ul></li><li>Record: A promoted item is move to the head of the current queue.</li><li>Remove: The item is removed from the queue.</li><li>Eviction iterator: The iterator consists of two sub-iterators pointing
towards the tails of Tiny and Main. The overall iterator returns the less
frequently used item of the current two sub-iterators.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="common-configurations"><strong>COMMON CONFIGURATIONS</strong><a class="hash-link" href="#common-configurations" title="Direct link to heading">â€‹</a></h3><p>There are a few common set ups shared by all these three implementations.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="thread-safety"><strong>THREAD SAFETY</strong><a class="hash-link" href="#thread-safety" title="Direct link to heading">â€‹</a></h4><p>All of the operations are protected by a mutex.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="optional-promotion"><strong>OPTIONAL PROMOTION</strong><a class="hash-link" href="#optional-promotion" title="Direct link to heading">â€‹</a></h4><p>Configs on whether to update on a read and/or write can be specified. For
example if updateOnRead is set to false, no operation would be taken if the
item is read.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="lru-refresh-time"><strong>LRU REFRESH TIME</strong><a class="hash-link" href="#lru-refresh-time" title="Direct link to heading">â€‹</a></h4><p>LRU refresh time is an interval within which consecutive record access won&#x27;t
re-promote the item. The intention for this mechanism is to reduce lock
contention. LRU refresh time is calculated on the oldest element&#x27;s age
multiplied by lruRefreshRatio set in config and capped by a max time (currently
900 seconds). It is recalculated once every time interval as specified in the
config (mmReconfigureIntervalSecs). The different MMContainers do have slightly
different implementations:</p><ul><li>In MMLru, items accessed for the first time are not constrained by LRU
refresh time and will be promoted for sure. It uses the time difference between
current time and the tail item&#x27;s last update time as the oldest element age.  *
In MMTiny-LFU, items accessed for the first time are not constrained by LRU
refresh time and will be promoted for sure. It uses the time difference between
current time and the tail of main queue&#x27;s last update time as the oldest
element age.</li><li>In MM2Q, the time difference between current time and the tail of wamr queue
is used as the oldest element age.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="eviction-age-statistics"><strong>EVICTION AGE STATISTICS</strong><a class="hash-link" href="#eviction-age-statistics" title="Direct link to heading">â€‹</a></h4><p><strong>EvictionAgeStat</strong> (<code>struct EvictionAgeStat</code> in
<code>cachelib/allocator/CacheStats.h</code>) can be retrieved from all of the
implementations. The projectedAge is calculated when the caller calls eviction
stat with a projectedLength &gt; 0. It is the time difference between current and
the last updated time of the projectedLength&#x27;th item from the tail of the major
queue.</p><ul><li>For MMLru, there is only one queue and its statistics is populated into
warmQueueStat while the other two queue stats are left 0.</li><li>For MM2Q, all the stats are populated. The major queue that is used for
projection is the warm queue.</li><li>For MMTiny-LFU, only the main queue&#x27;s stats is populated into warmQueueStat.
And the main queue is used for projection.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary"><strong>Summary</strong><a class="hash-link" href="#summary" title="Direct link to heading">â€‹</a></h2><p>In this article we went over the indexing (Access Container) and eviction (MM
Container) mechanism of CacheLib. They are implemented by intrusive hooks in
the CacheItem. For public API in CacheAllocator, AccessContainer and
MMContainer works together to perform indexing and eviction management
efficiently.</p><p>Usually, when the API takes a key from the client, <code>AccessContainer::find</code> is
used to locate the CacheItem. Then the MMContainer can be identified from the
item and operation can be performed in constant time.  The most time overhead
on common cache operations (find, insert, remove) is two iterations on the hash
table&#x27;s chain, which is still quite efficient (happens on remove).</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/CacheLib/edit/main/website/docs/Cache_Library_Architecture_Guide/RAM_cache_indexing_and_eviction.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Cache_Library_Architecture_Guide/ram_cache_design"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">RAM Cache Design</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Cache_Library_Architecture_Guide/slab_rebalancing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Slab Rebalancing - How Does It Work?</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#containers" class="table-of-contents__link toc-highlight"><strong>Containers</strong></a></li><li><a href="#accesscontainer" class="table-of-contents__link toc-highlight"><strong>AccessContainer</strong></a><ul><li><a href="#chainedhashtable" class="table-of-contents__link toc-highlight"><strong>CHAINEDHASHTABLE</strong></a></li></ul></li><li><a href="#mmcontainer" class="table-of-contents__link toc-highlight"><strong>MMContainer</strong></a><ul><li><a href="#dlist" class="table-of-contents__link toc-highlight"><strong>DLIST</strong></a></li><li><a href="#lru" class="table-of-contents__link toc-highlight"><strong>LRU</strong></a></li><li><a href="#lru-2q" class="table-of-contents__link toc-highlight"><strong>LRU-2Q</strong></a></li><li><a href="#tiny-lfu" class="table-of-contents__link toc-highlight"><strong>TINY-LFU</strong></a></li><li><a href="#common-configurations" class="table-of-contents__link toc-highlight"><strong>COMMON CONFIGURATIONS</strong></a></li></ul></li><li><a href="#summary" class="table-of-contents__link toc-highlight"><strong>Summary</strong></a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Reach Us</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.facebook.com/cachelib/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Developer Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/MetaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2024 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4ad039a1.js"></script>
<script src="/assets/js/main.349c8c72.js"></script>
</body>
</html>