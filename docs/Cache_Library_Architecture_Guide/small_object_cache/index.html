<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CacheLib Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CacheLib Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="CacheLib" href="/opensearch.xml"><title data-react-helmet="true">Small Object Cache | CacheLib</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-react-helmet="true" name="twitter:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-react-helmet="true" property="og:url" content="https://cachelib.org/docs/Cache_Library_Architecture_Guide/small_object_cache"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Small Object Cache | CacheLib"><meta data-react-helmet="true" name="description" content="The Small Object Cache (SOC)   caches objects that are 100s of bytes in size using 100s of GB of SSD. SOC is implemented as a set associative cache to reduce the DRAM overhead for indexing.  SOC is initialized with large range of blocks specified through a start offset and size."><meta data-react-helmet="true" property="og:description" content="The Small Object Cache (SOC)   caches objects that are 100s of bytes in size using 100s of GB of SSD. SOC is implemented as a set associative cache to reduce the DRAM overhead for indexing.  SOC is initialized with large range of blocks specified through a start offset and size."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/small_object_cache"><link data-react-helmet="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/small_object_cache" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/small_object_cache" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.88c68b34.css">
<link rel="preload" href="/assets/js/runtime~main.d499e1a3.js" as="script">
<link rel="preload" href="/assets/js/main.70a77d5d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarContent_6uhP">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">CacheLib</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/installation/installation">Build and Installation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">API and Usage</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_User_Guides/Cachebench_Overview">Cachebench</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Architecture Guide</a><a class="navbar__item navbar__link" href="/">â€Œ</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/learnmore/">Learn More</a><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_NKBi"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Architecture Guide</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">RAM Cache</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Hybrid Cache</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/hybrid_cache">Hybrid Cache</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/navy_architecture_overview">Navy Architecture Overview</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/small_object_cache">Small Object Cache</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/large_object_cache">Large Object Cache</a></li></ul></li></ul></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_XoVD"><div class="docItemContainer_6jsP"><article><header><h1 class="docTitle_ft6A">Small Object Cache</h1></header><div class="markdown"><p>The Small Object Cache (SOC)   caches objects that are 100s of bytes in size using 100s of GB of SSD. SOC is implemented as a set associative cache to reduce the DRAM overhead for indexing.  SOC is initialized with large range of blocks specified through a start offset and size.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="buckets"></a>Buckets<a class="hash-link" href="#buckets" title="Direct link to heading">#</a></h2><p>SOC divides the available range of block space into fixed size buckets. The size of the <code>Bucket</code> is typically the smallest unit of read into the SSD(4KB), but is configurable. A<code>Bucket</code> has a  header followed by sequence of key value pairs.  The header encapsulates the following:</p><ul><li>a checksum that is used for validating the content of bucket against IO errors.</li><li>generation timestamp that is used to determine if the bucket is properly intialized.</li><li>capacity, number of keys and offset of next allocation to manage the storage portion.</li></ul><p>The header in total consumes 24 bytes per bucket. Following the header bits is sequence of key, value pairs corresponding to <code>BucketEntry</code>.  <code>BucketEntry</code> contains a key size,  value size and hash for quick search, followed by actual key and value. The overhead for <code>BucketEntry</code> is 20 bytes per entry.</p><p>Buckets are always read entirely and written entirely. SOC uses an array of <code>folly::SharedMutex</code> to protect concurrent reads and writes to the corresponding bucket associatively.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="lookups"></a>Lookups<a class="hash-link" href="#lookups" title="Direct link to heading">#</a></h2><p>Keys are associatively hashed into the buckets based on a uniform hash function.
Since hybrid caches are usually leveraged in deployments that have 50-80% hit ratio, a significant volume of lookups could be for keys that don&#x27;t exist. To speed up the performance of lookups, SOC can be configured to use a <code>BloomFilter</code>. The  <code>BloomFilter</code> is utilized to quickly answer if a key might be missing from the cache.  To perform a lookup, SOC computes the hash of the key to locate the <code>Bucket</code> corresponding to it. It then checks the corresponding <code>BloomFilter</code> to quickly determine if the key could exist. If positive, only then SOC performs the IO operation to read the <code>Bucket</code> into memory. Once read, the key value pairs are iterated quickly to locate the key being looked up. Due to the nature of the <code>BloomFilter</code>, SOC can have false positives. By controlling the bits per bucket, the false positive rate can be kept low (&lt;7% with 16 bytes per 4KB bucket). SOC can efficiently cache billions of keys and perform lookups with single IO while consuming only 1-2GB of DRAM. To keep the DRAM overhead low, SOC does not adopt eviction policies like LRU that need additional DRAM overhead or additional writes into SSD to maintain ordering information. SOC employs a simple FIFO eviction policy.</p><p><img src="/assets/images/Small_Item_engine_Read-1d0b3a1ea4976f74de8f119017b1aad8.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="inserts"></a>Inserts<a class="hash-link" href="#inserts" title="Direct link to heading">#</a></h2><p>To insert a cache into SOC, the key hash is used to determine the bucket. The <code>Bucket</code> is read into memory and if the key already exists and needs to be overridden, it is first removed and the <code>Bucket</code> is compacted in-memory. Next, SOC determines if there is sufficient space left in the <code>Bucket</code> to insert the new value for the key. Most often, caches operate being at full capacity. Hence, the <code>Bucket</code> would be full and SOC now has to pick a victim. To pick a victim, SOC employs a FIFO eviction policy. Keys are iterated in FIFO order and removed until there is enough space to insert the new key. SOC issues the removeCB for all evicted keys. Next, SOC writes the new state of the <code>Bucket</code> into SSD and reinitializes the <code>BloomFilter</code> to reflect the current content of the <code>Bucket</code>. The <code>BloomFilter</code> for any given bucket is updated upon every insert or delete operation that changes  the  contents of the <code>Bucket</code>.</p><p><img src="/assets/images/Small_Item_engine_Write-2c909e82adc02b6d2654560a59b84a06.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="deletes"></a>Deletes<a class="hash-link" href="#deletes" title="Direct link to heading">#</a></h2><p>Deletes are similar to insertion of keys when the key is present in SOC. SOC can quickly confirm if the key can be present. If so, SOC reads the <code>Bucket</code>, scans through the keys to remove an compact the <code>Bucket</code>. Once this is done, the new contents  of the <code>Bucket</code> are written into SSD and <code>BloomFilter</code> is re-initialized as well.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="persistence-across-restarts"></a>Persistence across restarts<a class="hash-link" href="#persistence-across-restarts" title="Direct link to heading">#</a></h2><p>SOC stores the keys and value in SSD. When SOC  is shutdown cleanly, it persists any relevant state in memory to SSD. SOC currently stores only the <code>BloomFilter</code> in memory and maintains some statistics related to the distribution of object sizes. Upon a successful initilaization, SOC can reinitialize the <code>BloomFilter</code> from the previously persisted state if the parameters have not changed.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="soc-operation-cost"></a>SOC operation cost<a class="hash-link" href="#soc-operation-cost" title="Direct link to heading">#</a></h2><p>The following table summarizes the cost of various operations to SOC under correponding scenarios. Cache workloads have fair volume of lookups and deletes for non-existent keys. All misses are handled in-memory, while lookups for keys hit can be serviced with a single IO corresponding to bucket size.  For inserts and deletes that mutate the <code>Bucket</code>, it involves two IO opertions(a read and a write). Deletes for non-existent keys are also purely in-memory operations.</p><p><img src="/assets/images/SOC_cost_of_operations-b91db1af306bc356a314f9bca1c84e69.png"></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/CacheLib/edit/main/website/docs/Cache_Library_Architecture_Guide/Small_Object_Cache.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/Cache_Library_Architecture_Guide/navy_architecture_overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Navy Architecture Overview</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Cache_Library_Architecture_Guide/large_object_cache"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Large Object Cache Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#buckets" class="table-of-contents__link">Buckets</a></li><li><a href="#lookups" class="table-of-contents__link">Lookups</a></li><li><a href="#inserts" class="table-of-contents__link">Inserts</a></li><li><a href="#deletes" class="table-of-contents__link">Deletes</a></li><li><a href="#persistence-across-restarts" class="table-of-contents__link">Persistence across restarts</a></li><li><a href="#soc-operation-cost" class="table-of-contents__link">SOC operation cost</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Reach Us</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.facebook.com/cachelib/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Facebook Developer Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/MetaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_SRtH"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d499e1a3.js"></script>
<script src="/assets/js/main.70a77d5d.js"></script>
</body>
</html>