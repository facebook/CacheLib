<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-facebook/Working_Set_Analysis/WSA_logging_library">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">A practical guide to Working Set Analysis Logging Library | CacheLib</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-rh="true" name="twitter:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-rh="true" property="og:url" content="https://cachelib.org/docs/facebook/Working_Set_Analysis/WSA_logging_library"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="A practical guide to Working Set Analysis Logging Library | CacheLib"><meta data-rh="true" name="description" content="This page describes about how you can add logging supported by Working Set Analysis Logging Library into your c++ code base."><meta data-rh="true" property="og:description" content="This page describes about how you can add logging supported by Working Set Analysis Logging Library into your c++ code base."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cachelib.org/docs/facebook/Working_Set_Analysis/WSA_logging_library"><link data-rh="true" rel="alternate" href="https://cachelib.org/docs/facebook/Working_Set_Analysis/WSA_logging_library" hreflang="en"><link data-rh="true" rel="alternate" href="https://cachelib.org/docs/facebook/Working_Set_Analysis/WSA_logging_library" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CacheLib RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CacheLib Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="CacheLib" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.9576b86a.css">
<link rel="preload" href="/assets/js/runtime~main.c10705de.js" as="script">
<link rel="preload" href="/assets/js/main.a9e49b72.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script>

<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#20232a;color:#fff" role="banner"><div class="content_knG7 announcementBarContent_xLdY">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">CacheLib</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/installation">Build and Installation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">User Guide</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_User_Guides/Cachebench_Overview">Cachebench</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Architecture Guide</a><a class="navbar__item navbar__link" href="/">â€Œ</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/learnmore/">Learn More</a><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>A practical guide to Working Set Analysis Logging Library</h1></header><p>This page describes about how you can add logging supported by Working Set Analysis Logging Library into your c++ code base.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisite">Prerequisite<a class="hash-link" href="#prerequisite" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-logger-config-in-www">Create the logger config in www<a class="hash-link" href="#create-the-logger-config-in-www" title="Direct link to heading">â€‹</a></h3><p>Follow <a href="https://www.internalfb.com/intern/wiki/LoggerGuide/Logger_Everywhere/logger-in-c/" target="_blank" rel="noopener noreferrer">this page</a> to create a logger config in www repo (Hack), see example <a href="https://internalfb.com/D25831871" target="_blank" rel="noopener noreferrer">D25831871</a>.
Canonical column: <a href="https://www.internalfb.com/intern/logger/canonical_fields" target="_blank" rel="noopener noreferrer">https://www.internalfb.com/intern/logger/canonical_fields</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actualize-your-config">Actualize your config<a class="hash-link" href="#actualize-your-config" title="Direct link to heading">â€‹</a></h3><p>Run this command in www to actualize your config (create and initialize hive table).</p><p><em>After actualizing you config, there will be some restrictions to change your config</em></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">phps LoggerSync Actualize YourLoggerConfig &amp;&amp; meerkat</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can search your table name in Scuba to see what you have created, you will find multiple tables in your table name with different suffix, you will only find your data in your table after 24 hours, but you may see data in table ending <code>inc_archive</code> in hourly basis. For the meanings of the suffix, see <a href="https://fb.workplace.com/groups/allthelogs/permalink/5009569385758303/" target="_blank" rel="noopener noreferrer">this post</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sync-config-to-fbcode">Sync config to fbcode<a class="hash-link" href="#sync-config-to-fbcode" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cd fbsource/fbcode</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">dsi/logger/cpp/sync_logger config YourLoggerConfig</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">buck build dsi/logger/configs/YourLoggerConfig:logger</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="modify-the-logger-config">Modify the logger config<a class="hash-link" href="#modify-the-logger-config" title="Direct link to heading">â€‹</a></h3><ul><li>Add new column (non-partition): this is simple, just add a new column in the php file.</li><li>Add partition column / change paritions: this is not allowed, you have to rename your table (new table).</li><li>Change column type: It&#x27;s not recommended to do so, it&#x27;s better to give it a new name (new column).</li><li>For more, refer to <a href="https://www.internalfb.com/intern/wiki/LoggerGuide/Quickstart_Introduction/Changing_Your_Config/" target="_blank" rel="noopener noreferrer">this page</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a class="hash-link" href="#overview" title="Direct link to heading">â€‹</a></h2><p>Since you have a logger powered by config that takes care of actualiziation (creating underlying scribe/scuba/hive tables) for you, you may wonder what is stopping you from calling logger.log() wherever you want right now. WSALoggingLib provides two functionality:</p><ol><li>It supports different sampling rate based on criterium defined by you.</li><li>It supports customized aggregation.</li></ol><p>In order to power these two functionality, it requires you to provide more configs to the library and your customized logic to consume those configs.</p><p>Below is how logging with WSALoggingLib works. Let&#x27;s call the application <code>X</code>.</p><ol><li>When the application code has an event to log, it sends it to <code>XWorkingSetTracker</code>.</li><li><code>XWorkingSetTracker</code> holds <code>XWorkingSetSampler</code> and <code>XRequestLog</code>. Upon the receipt of an new event, it tests whether the event passes sampling with the sample. If it does, it forwards it to <code>XRequestLog</code>.</li><li><code>XRequestLog</code> holds <code>XRequestRecordAggregator</code>. Upon the receive of the event, it creates a <code>XRequestRecord</code> based on the event. And it will be aggregated to the events with the same key.</li><li><code>XRequestRecordAggregator</code> wraps around the actual logger that logs to remote service and holds a buffer of all records being aggregated in the aggregation interval. Once the aggregation interval is reached or the buffer fills up, it sends the aggregated records to the logging service (Hive) and flushes the buffer.</li></ol><p>You will be defining all these classes whose name starts with X. But a lot of them just needs to be a definition that fills class names into already defined generic templates. And the logic required form you would mostly be related to your application&#x27;s business logic.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-classes-to-create">What classes to create<a class="hash-link" href="#what-classes-to-create" title="Direct link to heading">â€‹</a></h2><p>You don&#x27;t have to provide all of the above implementations from scratch. In fact, a lot of time you just need to create a class by specifying class names into generic classes provided by WSALoggingLib.</p><p>This diff <a href="https://internalfb.com/D21512456" target="_blank" rel="noopener noreferrer">D21512456</a> contains all the classes you need to add to your code base to utilize WSALoggingLib. We&#x27;ll group all these classes by their purpose and talk about each of them.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sampling">Sampling<a class="hash-link" href="#sampling" title="Direct link to heading">â€‹</a></h3><p>There are classes that tells how we do sampling. Sampling means given an event, whether we add this event into aggregation and eventually log to remote logger. Sampling is captured by WarmStorageSampler.h. The goal is that we want to create a subclass of <a href="https://fburl.com/diffusion/641ectqt" target="_blank" rel="noopener noreferrer"><code>Sampler</code></a> of specific types. In order to do so, we need to provide host info, telling the sampler the information of the current host (in order to select config from configerator), and a SamplerImpl, providing information about detail sampling implementation.</p><p>So below are the classes that we need to define/modify.</p><ul><li><a href="https://fburl.com/diffusion/sdcy0p6n" target="_blank" rel="noopener noreferrer">WarmStorageHostInfo</a>: This is the host info class which will be used to initialize the sampler, provided by the client application.</li><li><a href="https://fburl.com/diffusion/dv4muymd" target="_blank" rel="noopener noreferrer">WarmStorageSamplerImpl.cpp</a>: WarmStorage samples by the blockID and host. SO we can use <a href="https://fburl.com/diffusion/gistsejb" target="_blank" rel="noopener noreferrer">KvSamplerImpl</a> for implementation. All we need to do is to supply a static function of <code>graphene::ws::KvSamplerImpl::buildNewSampler</code>, which provides the logic to create a <code>KvSamplerImpl</code> from host information.<ul><li>WarmStorageSamplerImpl.cpp can be renamed to anything as long as it provides KvSamplerImpl::buildNewSampler.</li></ul></li><li><a href="https://fburl.com/diffusion/mzx8iaav" target="_blank" rel="noopener noreferrer">WarmStorageSampler.h</a>: Just to define the class <code>WarmStorageSampler</code></li></ul><p>Please notice that the key for the sample could be different from the record key that we would talk about later. The sampler does not store any state about the keys it sample.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="behind-the-scene">Behind the scene<a class="hash-link" href="#behind-the-scene" title="Direct link to heading">â€‹</a></h4><ul><li>The base class <a href="https://fburl.com/diffusion/2jipbyxj" target="_blank" rel="noopener noreferrer"><code>Sampler</code></a>contains logic to interact with configs changes. It supports subscription to a configerator config and handles thread safety of the rotation of config updates.</li><li>When we call <a href="https://fburl.com/diffusion/xnk9ez5e" target="_blank" rel="noopener noreferrer"><code>warmStorageSmampler.sampleRequest</code></a>, sampler finds the current active samplerImpl (<a href="https://fburl.com/diffusion/5m8w6iyn" target="_blank" rel="noopener noreferrer">https://fburl.com/diffusion/5m8w6iyn</a>). Since we are calling with folly::StringPiece, KvSamplerImpl will use this <a href="https://fburl.com/diffusion/n0w3nvny" target="_blank" rel="noopener noreferrer">sample</a> function, which uses furcHash on the string key.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="record">Record<a class="hash-link" href="#record" title="Direct link to heading">â€‹</a></h3><p><a href="https://fburl.com/diffusion/i8vfeamp" target="_blank" rel="noopener noreferrer">WarmStorageRequestRecord.h</a> defines the record class. Every WSALoggingLib record class is a <code>graphene::ws::RequestRecord of</code> certain key type. <a href="https://fburl.com/diffusion/eavvpgkp" target="_blank" rel="noopener noreferrer">WarmStorageRequestKey</a> is the unit of aggregation, which means within the update interval, all the records with the same key will be merged together. For warm storage, every field of the record is part of the key. So when merge happens, only the <a href="https://fburl.com/diffusion/xtr4al7m" target="_blank" rel="noopener noreferrer">opCount</a> field of the base RequestRecord base class will be incremented.</p><p>In another example, <a href="https://fburl.com/diffusion/b4hd1bv6" target="_blank" rel="noopener noreferrer">ZippyDBRecord</a> has field that are merged in its own <code>merge</code> function.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="aggregator">Aggregator<a class="hash-link" href="#aggregator" title="Direct link to heading">â€‹</a></h3><p>To user the aggregation, we need to define the following classes:</p><ul><li><a href="https://fburl.com/diffusion/pjabms42" target="_blank" rel="noopener noreferrer">WarmStorageRequestRecordAggregator</a> = <code>RequestRecordAggregator&lt;WarmStorageRequestRecord&gt;</code>. This simply defines an interface class that consumes the record class.</li><li><a href="https://fburl.com/diffusion/0csjpg6r" target="_blank" rel="noopener noreferrer">WarmStorageRequestRecordAggregatorHive</a>: This is the implementation of the aggregator that finally logs the aggregated records to Hive. This class also populates host information into the hive record.</li><li><a href="https://fburl.com/diffusion/n4q9ujt2" target="_blank" rel="noopener noreferrer">WarmStorageRequestLog</a> = <code>RequestLog&lt;WarmStorageRequestRecord, folly::SpinLock&gt;</code></li></ul><p>That&#x27;s it. There is very little myth to implement since all the complicated processing are hidden in the base class below.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="behind-the-scene-1">Behind the scene<a class="hash-link" href="#behind-the-scene-1" title="Direct link to heading">â€‹</a></h4><ul><li>The base class <a href="https://fburl.com/diffusion/07mu6cx8" target="_blank" rel="noopener noreferrer">RequestLog</a> contains the core logic for aggregation. This class stores data in a <a href="https://fburl.com/diffusion/j29slucd" target="_blank" rel="noopener noreferrer">number</a> of <a href="https://www.internalfb.com/intern/diffusion/FBS/browse/master/fbcode/graphene/working_set/common/RequestLog.h?commit=6ee0e67a92c7&amp;lines=499" target="_blank" rel="noopener noreferrer">shards</a>. Each shard contains a map from keys to records. The reason for sharding is to reduce locking contention.</li><li>Each shard has its own memory arena to store variable sized keys (strings).</li><li>A thread runs an <a href="https://fburl.com/diffusion/pm6nzwze" target="_blank" rel="noopener noreferrer">aggregation loop</a> that collects shards that can be aggregated and log to remote logging and flush the memory.</li><li>When the a new event comes, <a href="https://fburl.com/diffusion/uzdp0gdk" target="_blank" rel="noopener noreferrer">recordOperation</a> gets called and it is where <a href="https://fburl.com/diffusion/k7kfx8kt" target="_blank" rel="noopener noreferrer">record merge</a> happens.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="api">API<a class="hash-link" href="#api" title="Direct link to heading">â€‹</a></h3><p>The lass class we need to define is the interface class where the application holds a reference and call into.</p><p>The class <a href="https://fburl.com/diffusion/iyo9v0wk" target="_blank" rel="noopener noreferrer"><code>WarmStorageWorkingSetTracker</code></a> contains the WarmStorageSampler and WarmStorageRequestLog. It provides one customized method <a href="https://fburl.com/diffusion/avxrl328" target="_blank" rel="noopener noreferrer">logOP</a> that can be called by the application to send an event. We initialize this class with some parameters that it feeds into either the sample or request log:</p><ul><li>nShards: Number of shards for the RequestLog. This number does not affect the overall size since the below max configs are for overall not per shard.</li><li>collectionInterval: Default collection time interval. Records will be flushed at least once per this time interval.</li><li>maxBacklog: Largest number of aggregated records we keep before flushing.</li><li>maxBufferSize: The size of buffer (arena size) that stores the variable sized keys. This is roughly the memory &quot;overhead&quot; by WSALoggingLib.</li></ul><p>Example of logging in application: <a href="https://fburl.com/diffusion/k3rsv2m0" target="_blank" rel="noopener noreferrer">https://fburl.com/diffusion/k3rsv2m0</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="unit-tests">Unit tests<a class="hash-link" href="#unit-tests" title="Direct link to heading">â€‹</a></h3><p>Please make sure you write unit tests! Examples: <a href="https://fburl.com/diffusion/qnb6p95n" target="_blank" rel="noopener noreferrer">https://fburl.com/diffusion/qnb6p95n</a></p><p>You can create mock aggregator to avoid logging to hive and to examine what you actually logged.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="canary-test">Canary Test<a class="hash-link" href="#canary-test" title="Direct link to heading">â€‹</a></h3><p>To test your code in production data, you need to setup a canary testing environement, build your pkg and deploy it to the canary machine.
The following steps/examples are for WarmStorage, other applications may be different.</p><ol><li>Ask a WarmStorage engineer (or @haowux) to set up a canary test cluster. You will get a cluster name, e.g. <code>ws.sandbox.denny07</code></li><li>Build the package. Make sure you have cloned configerator repo then run
<code>fbpkg build -E warm_storage.storage_service --expire 28d</code>
When you finished this sucessfully, you can see a finished progress bar like <code>============</code> and under that you can find your package <code>warm_storage.storage_service:xxxxxx</code></li></ol><p>You will be prompt for permission for the first time, request for two months. Then run the above command again it will succeed.
You should see the link to request permission in error message, but if not, use <a href="https://www.internalfb.com/intern/hipster/request/create/?acl_type=FBPKG&amp;acl_name=WARMSTORAGE_FBPKG" target="_blank" rel="noopener noreferrer">this link</a>.</p><p>Run <code>buck clean</code> before <code>fbpkg</code> to avoid running out of space in your dev server.</p><ol start="3"><li><p>Canary. We are canarying to <code>denny07</code>:<a href="https://www.internalfb.com/intern/tupperware/details/job/?handle=priv2_cln%2Fwarm_storage%2Fws.sandbox.denny07.storage_service" target="_blank" rel="noopener noreferrer">link</a>. Choose one task/host from the cluster, lets say we are using task 1, find the host name from above link, e.g. <code>warmstorage114.04.cln2</code></p></li><li><p>Canary the configerator config. Make your configerator change on the sampling config by adding sampling rate 1 to cluster <code>denny07</code> (rate 1 means chossing all). e.g. <a href="https://internalfb.com/D25934246" target="_blank" rel="noopener noreferrer">D25934246</a></p></li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">arc build</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">hg commit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">arc canary --hosts warmstorage114.04.cln2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="5"><li>now canary to ws</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sf canary --tw-job priv2_cln/warm_storage/ws.sandbox.denny07.storage_service --tasks 1 --duration 1d --sfid warm_storage/storage_service --num-control-tasks 0 -V warm_storage.storage_service:xxxxxx --canary-task-extra-args=&#x27;--sfn_cachelib_enable_ml_admission --sfn_cachelib_store_features --sfn_cachelib_ml_admission_metadata_override=&quot;conveyor_ash8strontium_20201111&quot; --sfn_cachelib_ml_admission_target_recall_override=0.7&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You will be prompt for permission for the first time, request for two months. Then run the above command again it will succeed.
You should see the link to request permission in error message, but if not, use <a href="https://www.internalfb.com/intern/hipster/request/create/?acl_type=TIER&amp;acl_name=ws-acl.customer.sandbox" target="_blank" rel="noopener noreferrer">this link</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-configs-to-create">What configs to create<a class="hash-link" href="#what-configs-to-create" title="Direct link to heading">â€‹</a></h2><p>There are two configs in configerator that needs to be supplied:</p><ul><li>Sampling config definition: <a href="https://internalfb.com/D21534544" target="_blank" rel="noopener noreferrer">D21534544</a></li><li>Adding specific sampling config for your hosts: <a href="https://internalfb.com/D21695295" target="_blank" rel="noopener noreferrer">D21695295</a><ul><li>This config can be picked up without restarting hosts if you set up the sampler <a href="https://fburl.com/diffusion/5rhxyzpl" target="_blank" rel="noopener noreferrer">by subscription</a>.</li><li>You may even define a host level config to test out your sampling by canarying this configerator change to one single host.</li></ul></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/CacheLib/edit/main/website/docs/facebook/Working_Set_Analysis/WSA_logging_library.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#prerequisite" class="table-of-contents__link toc-highlight">Prerequisite</a><ul><li><a href="#create-the-logger-config-in-www" class="table-of-contents__link toc-highlight">Create the logger config in www</a></li><li><a href="#actualize-your-config" class="table-of-contents__link toc-highlight">Actualize your config</a></li><li><a href="#sync-config-to-fbcode" class="table-of-contents__link toc-highlight">Sync config to fbcode</a></li><li><a href="#modify-the-logger-config" class="table-of-contents__link toc-highlight">Modify the logger config</a></li></ul></li><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#what-classes-to-create" class="table-of-contents__link toc-highlight">What classes to create</a><ul><li><a href="#sampling" class="table-of-contents__link toc-highlight">Sampling</a></li><li><a href="#record" class="table-of-contents__link toc-highlight">Record</a></li><li><a href="#aggregator" class="table-of-contents__link toc-highlight">Aggregator</a></li><li><a href="#api" class="table-of-contents__link toc-highlight">API</a></li><li><a href="#unit-tests" class="table-of-contents__link toc-highlight">Unit tests</a></li><li><a href="#canary-test" class="table-of-contents__link toc-highlight">Canary Test</a></li></ul></li><li><a href="#what-configs-to-create" class="table-of-contents__link toc-highlight">What configs to create</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Reach Us</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.facebook.com/cachelib/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Developer Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/MetaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2025 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c10705de.js"></script>
<script src="/assets/js/main.a9e49b72.js"></script>
</body>
</html>